
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Nginx系列——主要模块 | Roy.Yin&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Roy.Yin">
    

    
    <meta name="description" content="Nginx系列——主要模块在讲Nginx各个模块之前，先了解下Nginx的内置变量还是十分有必要的。变量说多不多，说少也不少，大家不必要全部记住，大概知道哪些就可以了。
内置变量123456789101112131415161718192021222324252627282930313233343536$arg_PARAMETER   #这个变量包含在查询字符串时GET请求PARAMETER的值。">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx系列——主要模块">
<meta property="og:url" content="http://yinrongping.github.io/2015/04/19/linux-nginx-2/index.html">
<meta property="og:site_name" content="Roy.Yin's Blog">
<meta property="og:description" content="Nginx系列——主要模块在讲Nginx各个模块之前，先了解下Nginx的内置变量还是十分有必要的。变量说多不多，说少也不少，大家不必要全部记住，大概知道哪些就可以了。
内置变量123456789101112131415161718192021222324252627282930313233343536$arg_PARAMETER   #这个变量包含在查询字符串时GET请求PARAMETER的值。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nginx系列——主要模块">
<meta name="twitter:description" content="Nginx系列——主要模块在讲Nginx各个模块之前，先了解下Nginx的内置变量还是十分有必要的。变量说多不多，说少也不少，大家不必要全部记住，大概知道哪些就可以了。
内置变量123456789101112131415161718192021222324252627282930313233343536$arg_PARAMETER   #这个变量包含在查询字符串时GET请求PARAMETER的值。">

    
    <link rel="alternative" href="/atom.xml" title="Roy.Yin&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Roy.Yin&#39;s Blog" title="Roy.Yin&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Roy.Yin&#39;s Blog">Roy.Yin&#39;s Blog</a></h1>
				<h2 class="blog-motto">不要见怪，不要见外</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yinrongping.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/04/19/linux-nginx-2/" title="Nginx系列——主要模块" itemprop="url">Nginx系列——主要模块</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://yinrongping.github.io/about" title="Roy.Yin" target="_blank" itemprop="author">Roy.Yin</a>
		
  <p class="article-time">
    <time datetime="2015-04-19T09:54:48.000Z" itemprop="datePublished"> 发表于 2015-04-19</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx系列——主要模块"><span class="toc-number">1.</span> <span class="toc-text">Nginx系列——主要模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#内置变量"><span class="toc-number">1.1.</span> <span class="toc-text">内置变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#location模块"><span class="toc-number">1.2.</span> <span class="toc-text">location模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rewrite模块"><span class="toc-number">1.3.</span> <span class="toc-text">Rewrite模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#if指令："><span class="toc-number">1.3.1.</span> <span class="toc-text">if指令：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#break指令"><span class="toc-number">1.3.2.</span> <span class="toc-text">break指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#return指令"><span class="toc-number">1.3.3.</span> <span class="toc-text">return指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set指令"><span class="toc-number">1.3.4.</span> <span class="toc-text">set指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite指令"><span class="toc-number">1.3.5.</span> <span class="toc-text">rewrite指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite_log指令"><span class="toc-number">1.3.6.</span> <span class="toc-text">rewrite_log指令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proxy模块"><span class="toc-number">1.4.</span> <span class="toc-text">Proxy模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upstream模块"><span class="toc-number">1.5.</span> <span class="toc-text">upstream模块</span></a></li></ol></li></ol>
		
		</div>
		
		<h1 id="Nginx系列——主要模块">Nginx系列——主要模块</h1><p>在讲Nginx各个模块之前，先了解下Nginx的内置变量还是十分有必要的。变量说多不多，说少也不少，大家不必要全部记住，大概知道哪些就可以了。</p>
<h2 id="内置变量">内置变量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$arg_PARAMETER</span>   <span class="comment">#这个变量包含在查询字符串时GET请求PARAMETER的值。</span></span><br><span class="line"><span class="variable">$args</span>            <span class="comment">#这个变量等于请求行中的参数。</span></span><br><span class="line"><span class="variable">$binary_remote_addr</span>  <span class="comment">#二进制码形式的客户端地址。</span></span><br><span class="line"><span class="variable">$body_bytes_sent</span>     <span class="comment">#传送页面的字节数  </span></span><br><span class="line"><span class="variable">$content_length</span>      <span class="comment">#请求头中的Content-length字段。</span></span><br><span class="line"><span class="variable">$content_type</span>        <span class="comment">#请求头中的Content-Type字段。</span></span><br><span class="line"><span class="variable">$cookie_COOKIE</span>       <span class="comment">#cookie COOKIE的值。</span></span><br><span class="line"><span class="variable">$document_root</span>       <span class="comment">#当前请求在root指令中指定的值。</span></span><br><span class="line"><span class="variable">$document_uri</span>        <span class="comment">#与$uri相同。</span></span><br><span class="line"><span class="variable">$host</span>       <span class="comment">#请求中的主机头(Host)字段，如果请求中的主机头不可用或者空，则为处理请求的server名称(处理请求的server</span></span><br><span class="line"><span class="comment">#的server_name指令的值)。值为小写，不包含端口</span></span><br><span class="line"><span class="variable">$hostname</span>  <span class="comment">#机器名使用 gethostname系统调用的值</span></span><br><span class="line"><span class="variable">$http_HEADER</span>   <span class="comment">#HTTP请求头中的内容，HEADER为HTTP请求中的内容转为小写，-变为_(破折号变为下划线)，</span></span><br><span class="line"><span class="comment">#例如：$http_user_agent(Uaer-Agent的值), $http_referer...</span></span><br><span class="line"><span class="variable">$sent_http_HEADER</span> <span class="comment">#HTTP响应头中的内容，HEADER为HTTP响应中的内容转为小写，-变为_(破折号变为下划线)，</span></span><br><span class="line"><span class="comment">#例如： $sent_http_cache_control, $sent_http_content_type...;</span></span><br><span class="line"><span class="variable">$is_args</span>       <span class="comment">#如果$args设置，值为"?"，否则为""。</span></span><br><span class="line"><span class="variable">$limit_rate</span>    <span class="comment">#这个变量可以限制连接速率。</span></span><br><span class="line"><span class="variable">$nginx_version</span>     <span class="comment">#当前运行的nginx版本号。</span></span><br><span class="line"><span class="variable">$query_string</span>      <span class="comment">#与$args相同。</span></span><br><span class="line"><span class="variable">$remote_addr</span>       <span class="comment">#客户端的IP地址。</span></span><br><span class="line"><span class="variable">$remote_port</span>       <span class="comment">#客户端的端口。</span></span><br><span class="line"><span class="variable">$remote_user</span>       <span class="comment">#已经经过Auth Basic Module验证的用户名。</span></span><br><span class="line"><span class="variable">$request_filename</span>  <span class="comment">#当前连接请求的文件路径，由root或alias指令与URI请求生成。</span></span><br><span class="line"><span class="variable">$request_body</span>      <span class="comment">#这个变量（0.7.58+）包含请求的主要信息。在使用proxy_pass或fastcgi_pass指令的location中比较有意义。</span></span><br><span class="line"><span class="variable">$request_body_file</span> <span class="comment">#客户端请求主体信息的临时文件名。</span></span><br><span class="line"><span class="variable">$request_completion</span> <span class="comment">#请求完成</span></span><br><span class="line"><span class="variable">$request_method</span>     <span class="comment">#这个变量是客户端请求的动作，通常为GET或POST。包括0.8.20及之前的版本中，这个变量总为mainrequest中的动作，如果当前请求是一个子请求，并不使用这个当前请求的动作。</span></span><br><span class="line"><span class="variable">$request_uri</span>       <span class="comment">#这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI。</span></span><br><span class="line"><span class="variable">$schemeHTTP</span>   <span class="comment">#方法（如http，https）。按需使用，例：</span></span><br><span class="line">rewrite ^(.+)$ <span class="variable">$scheme</span>://example.com<span class="variable">$1</span> redirect;</span><br><span class="line"><span class="variable">$server_addr</span> 服务器地址，在完成一次系统调用后可以确定这个值，如果要绕开系统调用，则必须在listen中指定地址并且使用<span class="built_in">bind</span>参数。</span><br><span class="line"><span class="variable">$server_name</span>    <span class="comment">#服务器名称。</span></span><br><span class="line"><span class="variable">$server_port</span>    <span class="comment">#请求到达服务器的端口号。</span></span><br><span class="line"><span class="variable">$server_protocol</span>  <span class="comment">#请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</span></span><br><span class="line"><span class="variable">$uri</span>    <span class="comment">#请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改。</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="location模块">location模块</h2><p>location是Nginx的重要模块，基本语法：location [=|~|~*|^~] /uri/ { … }</p>
<ol>
<li>“=” 严格匹配。如果这个查询匹配，那么将停止搜索并立即处理此请求</li>
<li>“^~” 表示URI定位必须以指定模式开始，如果匹配，停止搜索其他模式</li>
<li>“~” 和 “~*” 为区分大小写匹配和不区分大小写匹配</li>
<li>“!~”和“!~*” 为区分大小写不匹配和不区分大小不匹配</li>
<li>“@xxx” 表示定义location区段名，客户端不能访问，内部产生的请求可以,例如try_files或error_page</li>
<li>“/” 表示通用匹配，任何请求都会匹配到<br>如果多个location匹配按什么顺序呢？Nginx首先会按“=”去匹配，匹配不了然后按照“^~”匹配，如果还是匹配不了，就会按location的顺序匹配其他的规则，最后还是没匹配就使用“/”通用匹配。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#精确匹配，不能用正则</span></span><br><span class="line">location = /abc &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#URI定位匹配，可用正则</span></span><br><span class="line">location ^~ /abc &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#正则匹配 区分大小写</span></span><br><span class="line">location ~ /abc &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#正则匹配 不区分大小写</span></span><br><span class="line">location ~* /abc &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#匹配所有</span></span><br><span class="line">location  / &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Rewrite模块">Rewrite模块</h2><p>Nginx Rewrite模块作用：为了URL重定向，过滤危险的URL；相关指令包括if,rewrite,set,return,break等，其中最关键的就是rewrite。</p>
<h3 id="if指令：">if指令：</h3><p> 语法：if（condition）{}<br> 默认值：无<br> 作用域：server,location<br> 用于检查一个条件是否符合，如果条件符合，就执行大括号中的内容；if指令不支持嵌套，不支持多个条件的&amp;&amp;和||处理。<br>a.表达式为一个变量时,如果值为空或者任何以0开头的字符串都会当作false;<br>b.直接比较内容时,可以使用 = 和 !=;<br>c.正则表达式匹配时，可以使用“～”和“～*”,分别表示区分大小写匹配和不区分大小写匹配<br>d.可以使用“-f”和“!-f”来判断文件是否存在，使用“-d”和“!-d”判断目录是否存在，使用“-e”和“!-e”判断文件或者目录是否存在，使用“-e”和“!-e”判断文件是否可执行；<br>e.部分正则表达式在”()”中的匹配值可以通过$1至$9访问。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果UA包含”MSIE”,rewrite 请求到/msie目录下</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ MSIE) &#123;</span><br><span class="line">     rewrite ^(.*)$ /msie/<span class="variable">$1</span> <span class="built_in">break</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果cookie匹配正则,设置变量$id等于正则引用部分</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_cookie</span> ~* <span class="string">"id=([^;] +)(?:;|$)"</span> ) &#123;</span><br><span class="line">  <span class="built_in">set</span>  <span class="variable">$id</span>  <span class="variable">$1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果提交方法为POST,则返回状态405</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_method</span> = POST ) &#123;</span><br><span class="line">  <span class="built_in">return</span> <span class="number">405</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果请求的文件不存在</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="operator">-f</span>  <span class="variable">$request_file_name</span>)&#123;</span><br><span class="line">    <span class="built_in">break</span>;</span><br><span class="line">    proxy_pass http://<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果query string中包含”post=140″,永久重定向到example.com</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$args</span> ~ post=<span class="number">140</span>)&#123;</span><br><span class="line">  rewrite ^ http://example.com/ permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="break指令">break指令</h3><p>语法：break;<br>默认值：无<br>作用域：server,location,if<br>停止执行当前虚拟主机的后续rewrite指令集<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$slow</span>) &#123;</span><br><span class="line">    <span class="built_in">limit</span>_rate <span class="number">10</span>k;</span><br><span class="line">    <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="return指令">return指令</h3><p>语法：return code，return code URL，return URL;<br>默认值：无<br>作用域：server,location,if<br>停止处理并返回指定状态码(code)给客户端。非标准状态码444表示关闭连接且不给客户端发响应头。从0.8.42版本起，return支持响应URL重定向(对于301，302，303，307），或者文本响应(对于其他状态码).对于文本或者URL重定向可以包含变量。</p>
<h3 id="set指令">set指令</h3><p>语法：set variable value;<br>默认值：none<br>作用域：server,location,if<br>定义一个变量并赋值，值可以是文本，变量或者文本变量混合体。</p>
<h3 id="rewrite指令">rewrite指令</h3><p>语法：rewrite regex replacement [flag];<br>默认值：无<br>作用域：server,location,if<br>如果一个URI匹配指定的正则表达式regex，URI就按照replacement重写；rewrite按配置文件中出现的顺序执行。flags标志可以停止继续处理；如果replacement以”<a href="http://&quot;或&quot;https://&quot;开始，将不再继续处理，这个重定向将返回给客户端。" target="_blank" rel="external">http://&quot;或&quot;https://&quot;开始，将不再继续处理，这个重定向将返回给客户端。</a><br>falg参数：</p>
<ul>
<li><strong>last</strong> 停止处理后续rewrite指令集，然后对当前重写的新URI在rewrite指令集上重新查找；</li>
<li><strong>break</strong> 停止处理后续rewrite指令集，并不在重新查找,但是当前location内剩余非rewrite语句和location外的的非rewrite语句可以执行。</li>
<li><strong>redirect</strong> 如果replacement不是以<a href="http://或https://开始，返回302临时重定向,一般用于重定向到完整的URL(包含http[s]:部分" target="_blank" rel="external">http://或https://开始，返回302临时重定向,一般用于重定向到完整的URL(包含http[s]:部分</a>) ,地址栏会改变.</li>
<li><strong>permanent</strong> 返回301永久重定向，地址栏会改变。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="operator">-f</span> <span class="variable">$uri</span>) &#123;</span><br><span class="line">    <span class="built_in">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$uri</span> ~ ^/admin/)&#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="number">403</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#URL重写，如 /search/nginx--&gt;/search.php?q=nginx</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$uri</span> ~ ^/search/(.*)$) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$query</span> <span class="variable">$1</span>;</span><br><span class="line">    rewrite ^ /search.php?q=<span class="variable">$query</span>?;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注意：<br>1.rewrite只对相对路径进行匹配,不包含hostname;<br>2.正则表达regex式中包含 “}” 或 “;”, 那么整个表达式需要用双引号或单引号包围.<br>3.rewrite的正则是不匹配querystring的,所以默认情况下,querystring是自动追加到rewrite后的地址上的,如果不想自动追加query string,则在rewrite地址的末尾添加?<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewrite ^/users/(.*)$ /show?user=<span class="variable">$1</span>? last;</span><br></pre></td></tr></table></figure></p>
<h3 id="rewrite_log指令">rewrite_log指令</h3><p>语法：rewrite_log on|off;<br>默认值：rewrite_log off;<br>作用域：http,server,location,if<br>开启或关闭以notice级别打印rewrite处理日志到error log文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rewrite_<span class="built_in">log</span> on;</span><br><span class="line">error_<span class="built_in">log</span> logs/xxx.error.log notice;</span><br></pre></td></tr></table></figure></p>
<h2 id="Proxy模块">Proxy模块</h2><p>此模块的作用：将客户端的HTTP请求转到后端服务器，从而实现反向代理<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://localhost:<span class="number">8080</span>; <span class="comment">#设置代理服务器的端口，套接字或者url</span></span><br><span class="line">    proxy_pass_header Server;  <span class="comment">#该指令强制一些被忽略的头传递到客户端</span></span><br><span class="line">    proxy_redirect off; <span class="comment">#允许改写出现在HTTP头却被后端服务器触发重定向的URL,对相应本身不做任何处理</span></span><br><span class="line">    proxy_<span class="built_in">set</span>_header Host <span class="variable">$http_host</span>; <span class="comment">#允许你重新定义代理header值再转到后端服务器.目标服务器可以看到客户端的原始主机名</span></span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Real-IP <span class="variable">$remote_addr</span>; <span class="comment">#目标服务器可以看到客户端的真实ip，而不是转发服务器的ip</span></span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Scheme <span class="variable">$scheme</span>;</span><br><span class="line">    proxy_connect_timeout <span class="number">600</span>; <span class="comment">#跟后端服务器连接的超时时间，发起握手等候响应超时时间</span></span><br><span class="line">    proxy_<span class="built_in">read</span>_timeout <span class="number">600</span>;    <span class="comment">#连接成功,等候后端服务器的响应时间_其实已经进入后端的排队中等候处理。默认值： </span></span><br><span class="line">    proxy_send_timeout <span class="number">600</span>;   <span class="comment">#后端服务器回传时间_就是在规定时间内后端服务器必须传完所有的数据。设置代理服务器转发请求的超时时间，同样指完成两次握手后的时间，如果超过这个时间代理服务器没有数据转发到后端服务器，nginx将关闭连接。 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="upstream模块">upstream模块</h2><p>Nginx的upstream目前支持5种方式的分配：</p>
<ol>
<li><p>轮询（默认）<br>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream my &#123;</span><br><span class="line">   server <span class="number">192.168</span>.<span class="number">0.1</span>:<span class="number">8000</span>;</span><br><span class="line">   server <span class="number">192.168</span>.<span class="number">0.1</span>:<span class="number">8001</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>权重 weight<br>指定权重，weight和访问比率成正比，用于后端服务器性能不均的情况。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream my &#123;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">0.100</span> weight=<span class="number">4</span>;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">0.101</span> weight=<span class="number">8</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ip_hash<br>每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以<br>解决session不同步的问题。</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream my &#123;</span><br><span class="line">    ip_<span class="built_in">hash</span>;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">0.100</span>:<span class="number">80</span>;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">0.101</span>:<span class="number">80</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>fair（第三方）<br>按后端服务器的响应时间来分配请求，响应时间短的优先分配。需要安装Upstream Fair Balancer Module。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream my &#123;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">0.100</span>:<span class="number">80</span>;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">0.101</span>:<span class="number">80</span>;</span><br><span class="line">    fair;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>url_hash（第三方）<br>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务<br>器为缓存时比较有效。需要安装Upstream Hash Module.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream my &#123;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">0.100</span>:<span class="number">80</span>;</span><br><span class="line">    server <span class="number">192.168</span>.<span class="number">0.101</span>:<span class="number">80</span>;</span><br><span class="line">    <span class="built_in">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>每个server都可以配置自己的状态：<br><strong>down</strong>: 表示此服务器不参与负载；<br><strong>weight</strong>：表示权重，默认值为1，权重越大，表示负载越大，一般根据服务器的性能分配；<br><strong>max_fails</strong>: 表示请求的最大失败次数，默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误；<br><strong>fail_timeout</strong>: 表示max_fails次失败后，暂停的时间；<br><strong>backup</strong>: 表示当其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。</p>
<p><strong>问题1：nginx如何判断节点为失效状态？</strong><br>答：Nginx 默认判断失败节点状态以connect refuse和time out状态为准，不以HTTP错误状态进行判断失败，因为HTTP只要能返回状态说明该节点还可以正常连接，所以nginx判断其还是存活状态，除非添加了proxy_next_upstream指令设置对404、502、503、504、500和time out等错误进行转到备机处理，在next_upstream过程中，会对fails进行累加，如果备用机处理还是错误则直接返回错误信息（但404不进行记录到错误数，如果不配置错误状态也不对其进行错误状态记录），综述，nginx记录错误数量只记录timeout 、connect refuse、502、500、503、504这6种状态，timeout和connect refuse是永远被记录错误状态，而502、500、503、504只有在配置proxy_next_upstream后nginx才会记录这4种HTTP错误到fails中，当fails大于等于max_fails时，则该节点失效。<br><strong>问题2：nginx 处理节点失效和恢复的触发条件是什么？</strong><br>答：nginx可以通过设置max_fails（最大尝试失败次数）和fail_timeout（失效时间，在到达最大尝试失败次数后，在fail_timeout的时间范围内节点被置为失效，除非所有节点都失效，否则该时间内，节点不进行恢复）对节点失败的尝试次数和失效时间进行设置，当超过最大尝试次数或失效时间未超过配置失效时间，则nginx会对节点状会置为失效状态，nginx不对该后端进行连接，直到超过失效时间或者所有节点都失效后，该节点重新置为有效，重新探测<br><strong>问题3：所有节点失效后nginx做什么？</strong><br>答：如果探测所有节点均失效，备机也为失效时，那么nginx会对所有节点恢复为有效，重新尝试探测有效节点，如果探测到有效节点则返回正确节点内容，如果还是全部错误，那么继续探测下去，当没有正确信息时，节点失效时默认返回状态为502，但是下次访问节点时会继续探测正确节点，直到找到正确的为止。</p>
<p>参考：<br>[1]  <a href="http://www.nginx.cn/216.html" target="_blank" rel="external">http://www.nginx.cn/216.html</a><br>[2]  <a href="http://blog.cafeneko.info/2010/10/nginx_rewrite_note/" target="_blank" rel="external">http://blog.cafeneko.info/2010/10/nginx_rewrite_note/</a><br>[3]  <a href="http://saiyaren.iteye.com/blog/1914865" target="_blank" rel="external">http://saiyaren.iteye.com/blog/1914865</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Nginx/">Nginx</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yinrongping.github.io/2015/04/19/linux-nginx-2/" data-title="Nginx系列——主要模块 | Roy.Yin&#39;s Blog" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2015/04/18/linux-nginx-1/"  title="Nginx系列——安装与配置">
 <strong>下一篇：</strong><br/> 
 <span>Nginx系列——安装与配置
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/04/19/linux-nginx-2/" data-title="Nginx系列——主要模块" data-url="http://yinrongping.github.io/2015/04/19/linux-nginx-2/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx系列——主要模块"><span class="toc-number">1.</span> <span class="toc-text">Nginx系列——主要模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#内置变量"><span class="toc-number">1.1.</span> <span class="toc-text">内置变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#location模块"><span class="toc-number">1.2.</span> <span class="toc-text">location模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rewrite模块"><span class="toc-number">1.3.</span> <span class="toc-text">Rewrite模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#if指令："><span class="toc-number">1.3.1.</span> <span class="toc-text">if指令：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#break指令"><span class="toc-number">1.3.2.</span> <span class="toc-text">break指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#return指令"><span class="toc-number">1.3.3.</span> <span class="toc-text">return指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set指令"><span class="toc-number">1.3.4.</span> <span class="toc-text">set指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite指令"><span class="toc-number">1.3.5.</span> <span class="toc-text">rewrite指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite_log指令"><span class="toc-number">1.3.6.</span> <span class="toc-text">rewrite_log指令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proxy模块"><span class="toc-number">1.4.</span> <span class="toc-text">Proxy模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upstream模块"><span class="toc-number">1.5.</span> <span class="toc-text">upstream模块</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Java/" title="Java">Java<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Nginx/" title="Nginx">Nginx<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/hexo/" title="hexo">hexo<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Nginx/" title="Nginx">Nginx<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/HashMap/" title="HashMap">HashMap<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/HashSet/" title="HashSet">HashSet<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ArrayList/" title="ArrayList">ArrayList<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hexo/" title="hexo">hexo<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://www.jianshu.com/" target="_blank" title="一个基于内容分享的社区">简书</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me/" target="_blank" title="本博客使用的hexo主题的作者">Jacman</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Roy.Yin. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="http://yinrongping.github.io/about" target="_blank" title="Roy.Yin">Roy.Yin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"royin"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
